reshapeNodes:

# Person
#
# A FHIR bundle contains one Patient, and that is mapped as a
# graph model Person. Below mappings also collect race information from the
# us-core-race extension
  
  "https://dartnet.info/graphModel/Person":
    evaluate: 
      - >-
        match (n:`https://hl7.org/fhir/Patient`) return n as patient
      - >-
        match (patient) -[*]->(raceExt:`https://hl7.org/fhir/Extension`) -[]->
             ({`https://lschema.org/value`:"http://hl7.org/fhir/us/core/StructureDefinition/us-core-race"})
             return raceExt as raceExtension
      - >-
        match (raceExtension) -[*]->(code {`https://lschema.org/attributeName`: "valueCoding"}) return code as raceCode
    valueExpr:  return patient
    mapContext: return patient

  "https://dartnet.info/graphModel/Person/race/source/code":
    valueExpr: >-
      match (raceCode) -[]->(code {`https://lschema.org/attributeName`: "code"}) return code

  "https://dartnet.info/graphModel/Person/race/source/system":
    valueExpr: >-
      match (raceCode) -[]->(system {`https://lschema.org/attributeName`: "system"}) return system
      

#
#  Observations
#
# For each observation in the bundle, we create graph model Observation object.
# The observation category is stored in the Observation type. An observation may contain
# a measured value, which is captured in Observation/measuredValue/source. Observation may include
# codes defining the observation, and these are collected under Observation/source


  "https://dartnet.info/graphModel/Person/observations/element":
    valueExpr: >-
      match (n:`https://hl7.org/fhir/Observation`) return n as observation
    mapContext: return observation

  # "https://dartnet.info/graphModel/Observation/type":
  #   evaluate:
  #     - >-
  #       match (observation)-[*]->(c)-[]->
  #              ({`https://lschema.org/value`:"http://terminology.hl7.org/CodeSystem/observation-category"})
  #              return c as observationTypeCode
  #   valueExpr: >-
  #     match (observationTypeCode)-[]->(s{`https://lschema.org/attributeName`:"code"}) return s


  "https://dartnet.info/graphModel/Observation/measuredValue/source":
    valueExpr: >-
      match (observation)-[]->(v {`https://lschema.org/attributeName`:"valueQuantity"}) return v as valueQuantity
    mapContext: return valueQuantity

    "https://dartnet.info/graphModel/Observation/source":
    valueExpr: >-
      match (observation)-[]->
           (v {`https://lschema.org/schemaNodeId`:"https://hl7.org/fhir/Observation/code/coding/*"})
           return v as observationCode
    mapContext: return observationCode

      


      
map:
  - source: "https://hl7.org/fhir/Patient/id"
    target: "https://dartnet.info/graphModel/Person/id"
  - source: "https://hl7.org/fhir/Patient/birthDate"
    target: "https://dartnet.info/graphModel/Person/birthDate"
  - source: "https://hl7.org/fhir/Patient/gender"
    target: "https://dartnet.info/graphModel/Person/gender/source/text"


  - source: "https://hl7.org/fhir/Observation/effectiveDateTime"
    target: "https://dartnet.info/graphModel/Observation/date"
  - source: "https://hl7.org/fhir/Observation/valueQuantity/value"
    target: "https://dartnet.info/graphModel/Observation/measuredValue/source/value"
  - source: "https://hl7.org/fhir/Observation/valueQuantity/unit"
    target: "https://dartnet.info/graphModel/Observation/measuredValue/source/unit"
  - source: "https://hl7.org/fhir/Observation/valueQuantity/system"
    target: "https://dartnet.info/graphModel/Observation/measuredValue/source/system"
  - source: "https://hl7.org/fhir/Observation/code/coding/*/system"
    target: "https://dartnet.info/graphModel/Observation/source/system"
  - source: "https://hl7.org/fhir/Observation/code/coding/*/code"
    target: "https://dartnet.info/graphModel/Observation/source/code"
  - source: "https://hl7.org/fhir/Observation/code/coding/*/display"
    target: "https://dartnet.info/graphModel/Observation/source/text"
